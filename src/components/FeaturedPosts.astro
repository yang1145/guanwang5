---
import { Heading, Link } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'

/**
 * FeaturedPosts Component
 *
 * @description A component that displays featured blog posts from the news API (Client-side rendered)
 */
interface Props {
  /**
   * Additional classes to apply to the section
   */
  class?: string
  /**
   * The number of posts to display
   * @default 3
   */
  limit?: number
  /**
   * The title for the section
   * @default "最新资讯"
   */
  title?: string
}

const { class: className, limit = 3, title = '最新资讯' } = Astro.props
---

<section class:list={[className, 'my-64']} id="featured-posts">
  <div class="container">
    <Heading level="h2" class="mb-6">{title}</Heading>
    
    <!-- 加载状态 -->
    <div id="posts-loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      <p class="mt-2">加载中...</p>
    </div>

    <!-- 内容区域 -->
    <div id="posts-content" class="hidden">
      <div id="posts-grid" class="grid grid-cols-1 gap-12 md:grid-cols-2 lg:grid-cols-3"></div>
      <div class="mt-12">
        <Link href="/blog/" isButton animateOnHover animationType="nudge">
          阅读全部资讯
          <Icon aria-hidden="true" name="lucide:arrow-right" size="1.5rem" />
        </Link>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ limit }}>
  import { getNews } from '@utils/clientApi'

  const postsLoading = document.getElementById('posts-loading')
  const postsContent = document.getElementById('posts-content')
  const postsGrid = document.getElementById('posts-grid')

  const postImages = [
    '/posts/post-image-1.png',
    '/posts/post-image-2.png',
    '/posts/post-image-3.png',
  ]

  function truncateTitle(title: string): string {
    const words = title.split(' ')
    if (words.length <= 8) return title
    return words.slice(0, 8).join(' ') + '...'
  }

  function slugify(text: string): string {
    return text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim()
  }

  async function loadFeaturedPosts() {
    try {
      const response = await getNews(1, limit)
      const newsData = response.data

      const html = newsData.map((news, index) => {
        const truncatedTitle = truncateTitle(news.title)
        const shortUrl = slugify(news.id + '-' + truncatedTitle)
        const imageUrl = news.image_url || postImages[index % postImages.length]
        const excerpt = news.content.substring(0, 100) + (news.content.length > 100 ? '...' : '')

        return `
          <article class="card h-full flex flex-col border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
            <a href="/blog/${shortUrl}" class="block">
              <img src="${imageUrl}" alt="" class="w-full h-48 object-cover" loading="lazy" />
            </a>
            <div class="p-6 flex-1 flex flex-col">
              <h3 class="text-xl font-bold mb-2">
                <a href="/blog/${shortUrl}" class="hover:text-primary">${truncatedTitle}</a>
              </h3>
              <p class="text-gray-600 mb-4 flex-1">${excerpt}</p>
              <p class="text-sm text-gray-500">作者：${news.author} · 浏览量：${news.views}</p>
            </div>
          </article>
        `
      }).join('')

      if (postsGrid) {
        postsGrid.innerHTML = html
      }

      if (postsLoading) postsLoading.classList.add('hidden')
      if (postsContent) postsContent.classList.remove('hidden')
    } catch (error) {
      console.error('Failed to load featured posts:', error)
      if (postsLoading) postsLoading.innerHTML = '<p class="text-red-600">加载失败</p>'
    }
  }

  loadFeaturedPosts()
</script>

<style>
  .card {
    background-color: var(--background-color);
    border-color: var(--border-color-subtle);
  }

  .card:hover {
    border-color: var(--primary-color);
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
