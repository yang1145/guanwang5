---
import '../styles/tailwind.css'
import '../assets/scss/index.scss'
import themeConfig from '@theme-config'
import { SEO } from 'astro-seo'
import Header from '@components/Header.astro'
import Footer from '@components/Footer.astro'
import { ClientRouter } from 'astro:transitions'
import type { ImageMetadata } from 'astro'

interface Props {
  /**
   * The title of the page
   */
  title?: string
  /**
   * The description of the page
   */
  description?: string
  /**
   * The URL of the page
   */
  url?: string
  /**
   * The image path for social sharing (can be ImageMetadata or string path)
   */
  image?: ImageMetadata | string | null
  /**
   * The author of the page
   */
  author?: string
  /**
   * The type of content (default: 'website')
   */
  type?: 'website' | 'article'
  /**
   * Whether to use the title template (default: true)
   * Set to false to use the title as-is without appending site name
   */
  useTitleTemplate?: boolean
}

const {
  title = themeConfig.seo.title,
  description = themeConfig.seo.description ?? '',
  url = Astro.url.href,
  image = themeConfig.seo.image ?? null,
  author = themeConfig.seo.author ?? '',
  type = 'website',
  useTitleTemplate = true,
} = Astro.props

// For social sharing, we need the full absolute URL
// If image is an ImageMetadata object, use its src, otherwise treat as string path
const imagePath = image ? (typeof image === 'string' ? image : image.src) : '/social-preview-image.png'
const imageUrl = new URL(imagePath, Astro.site).href
---

<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <!-- favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- theme colors from config -->
    <style
      define:vars={{
        brandPrimary: themeConfig.colors.primary,
        brandSecondary: themeConfig.colors.secondary,
        brandNeutral: themeConfig.colors.neutral,
        brandOutline: themeConfig.colors.outline,
      }}
    >
      :global(:root) {
        --brand-primary: var(--brandPrimary);
        --brand-secondary: var(--brandSecondary);
        --brand-neutral: var(--brandNeutral);
        --brand-outline: var(--brandOutline);
      }
    </style>

    <SEO
      title={title}
      titleTemplate={useTitleTemplate ? `%s - ${themeConfig.seo.title}` : undefined}
      titleDefault={themeConfig.seo.title}
      description={description}
      canonical={url}
      openGraph={{
        basic: {
          title: title,
          type: type,
          image: imageUrl,
          url: url,
        },
        optional: {
          description: description,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        title: title,
        description: description,
        image: imageUrl,
      }}
      extend={{
        meta: [
          {
            name: 'author',
            content: author,
          },
        ],
      }}
    />

    <!-- Enable Astro View Transitions for all browsers -->
    <ClientRouter />
  </head>
  <body>
    <Header />
    <main id="main-content" transition:animate="fade">
      <slot />
    </main>
    <Footer />
    <style lang="scss" is:global>
      @use '../assets/scss/base/mixins' as *;

      // sticky footer on low content pages
      html,
      body {
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        overflow-x: clip;

        main {
          flex: 1 0 auto;
        }

        footer {
          flex-shrink: 0;
        }
      }

      pre {
        border: 2px solid var(--link-color);
        border-radius: 0.35rem;
        padding: 1rem;
      }

      .card {
        a {
          @include text-decoration(transparent, var(--foreground-color), 4px, 2px);
        }
      }
    </style>

    <script>
      import { getSiteConfig } from '@utils/clientApi'

      async function updateSiteTitle() {
        try {
          const response = await getSiteConfig()
          const config = response.data

          // 更新网站标题（如果当前标题包含网站名称）
          if (config.site_title && document.title) {
            // 保存当前页面标题（不含网站名）
            const currentPageTitle = document.title.split(' - ')[0] || document.title.split(' | ')[0]
            
            // 如果有页面标题，格式为 "页面标题 - 网站名称"
            if (currentPageTitle !== document.title) {
              document.title = `${currentPageTitle} - ${config.site_title}`
            } else {
              // 如果只有网站标题，直接使用
              document.title = config.site_title
            }
          }
        } catch (error) {
          console.error('Failed to update site title:', error)
        }
      }

      // 页面加载完成后更新标题
      updateSiteTitle()
      
      // 监听页面切换事件
      document.addEventListener('astro:page-load', updateSiteTitle)
    </script>
  </body>
</html>
