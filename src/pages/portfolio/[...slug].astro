---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
import SocialShares from '@components/SocialShares.astro'
import { Heading } from 'accessible-astro-components'

export function getStaticPaths() {
  // 返回空数组，所有路径都会被捕获并在客户端处理
  return []
}
---

<DefaultLayout title="加载中..." description="正在加载案例详情...">
  <div id="case-container">
    <!-- 加载状态 -->
    <div id="loading" class="text-center py-24">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
      <p class="mt-6 text-xl">加载中...</p>
    </div>

    <!-- 错误状态 -->
    <div id="error" class="hidden text-center py-24">
      <p class="text-xl text-red-600 mb-4">加载失败</p>
      <p class="text-gray-600 mb-6">案例不存在或服务暂时不可用</p>
      <a href="/portfolio" class="inline-block px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
        返回列表
      </a>
    </div>

    <!-- 案例内容 -->
    <div id="content" class="hidden">
      <PageHeader
        id="page-header"
        title="加载中..."
        subtitle=""
        bgType="bordered"
      />
      
      <section class="my-12">
        <div class="narrow space-content container" id="case-content"></div>
      </section>

      <section class="my-12">
        <div class="narrow space-content container">
          <Heading level="h2">分享此案例</Heading>
          <p>如果你喜欢这个案例，欢迎分享给同事或朋友。</p>
          <SocialShares />
        </div>
      </section>
    </div>
  </div>
</DefaultLayout>

<script>
  import { getProducts } from '@utils/clientApi'

  const loading = document.getElementById('loading')!
  const error = document.getElementById('error')!
  const content = document.getElementById('content')!
  const caseContent = document.getElementById('case-content')!

  async function loadCase() {
    loading.classList.remove('hidden')
    error.classList.add('hidden')
    content.classList.add('hidden')

    try {
      // 从 URL 路径中提取 ID
      const pathParts = window.location.pathname.split('/')
      const slug = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2]
      const productId = parseInt(slug.split('-')[0])
      
      if (isNaN(productId)) {
        throw new Error('Invalid case ID')
      }

      const response = await getProducts()
      const product = response.data.find(p => p.id === productId)

      if (!product) {
        throw new Error('Case not found')
      }

      const formattedDate = new Date(product.created_at).toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      })

      // 更新页面标题
      document.title = `${product.name} - 案例展示`

      // 更新 PageHeader
      const pageHeader = document.querySelector('#page-header')
      if (pageHeader) {
        const titleEl = pageHeader.querySelector('h1')
        const subtitleEl = pageHeader.querySelector('.subtitle')
        if (titleEl) titleEl.textContent = product.name
        if (subtitleEl) {
          subtitleEl.innerHTML = `${formattedDate} · 分类：${product.category}`
        }
      }

      // 渲染案例内容
      caseContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">项目介绍</h2>
        <div class="prose prose-lg max-w-none mb-8">
          <p class="text-xl leading-relaxed">${product.description}</p>
        </div>
        
        <h3 class="text-xl font-bold mb-4 mt-8">项目详情</h3>
        <p class="mb-6">
          本项目属于 <strong>${product.category}</strong> 类别，展示了我们在该领域的专业能力与交付经验。
          我们通过系统化的方法论与工程实践，帮助客户实现业务目标并持续优化产品体验。
        </p>

        <h3 class="text-xl font-bold mb-4">核心亮点</h3>
        <ul class="list-disc list-inside mb-6 space-y-2">
          <li>清晰的项目目标与可量化的成果指标</li>
          <li>完整的设计到开发流程与协作机制</li>
          <li>注重性能、可用性与长期可维护性</li>
          <li>基于真实场景的测试与优化迭代</li>
          <li>交付物包含完整文档与使用指南</li>
        </ul>

        <h3 class="text-xl font-bold mb-4">技术方案</h3>
        <p class="mb-6">
          我们采用现代化的技术栈与工程实践，确保项目的稳定性、可扩展性与团队协作效率。
          所有代码遵循统一的规范，配合自动化测试与部署流程，保障交付质量。
        </p>

        <h3 class="text-xl font-bold mb-4">项目成果</h3>
        <p class="mb-6">
          通过本项目的实施，客户在业务指标、用户体验与运营效率等方面均获得显著提升。
          我们也将关键经验沉淀为可复用的组件与方法论，用于后续项目的快速启动。
        </p>

        <div class="mt-12 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <h4 class="text-lg font-bold mb-2">项目信息</h4>
          <ul class="text-sm space-y-1">
            <li><strong>项目名称：</strong>${product.name}</li>
            <li><strong>项目分类：</strong>${product.category}</li>
            <li><strong>完成时间：</strong>${formattedDate}</li>
          </ul>
        </div>
      `

      loading.classList.add('hidden')
      content.classList.remove('hidden')
    } catch (err) {
      console.error('Failed to load case:', err)
      loading.classList.add('hidden')
      error.classList.remove('hidden')
    }
  }

  loadCase()
</script>

<style lang="scss" is:global>
  .narrow {
    margin-inline: auto;
    max-width: 65ch;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
