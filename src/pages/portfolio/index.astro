---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
import { Heading, Link } from 'accessible-astro-components'
---

<DefaultLayout
  title="案例展示"
  description="精选案例展示：覆盖不同业务场景的交付实践与解决方案。"
>
  <PageHeader
    title="案例展示"
    subtitle="这里汇总了我们的代表性案例，涵盖产品设计、前端工程与可用性优化等方向，便于快速了解交付能力与行业经验。"
    bgType="bordered"
  />

  <section class="my-12">
    <div class="container">
      <!-- 加载状态 -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <p class="mt-4 text-lg">加载中...</p>
      </div>

      <!-- 错误状态 -->
      <div id="error" class="hidden text-center py-12">
        <p class="text-lg text-red-600">加载失败，请稍后重试</p>
        <button id="retry-btn" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
          重试
        </button>
      </div>

      <!-- 内容区域 -->
      <div id="content" class="hidden">
        <!-- 标签筛选 -->
        <div class="mb-8">
          <Heading level="h2" size="h5" class="mb-2">标签筛选</Heading>
          <div id="tags-container" class="flex flex-wrap gap-4"></div>
        </div>

        <p id="case-count" class="text-sm mb-4"></p>
        <ul id="case-list" class="mt-3 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"></ul>
      </div>
    </div>
  </section>
</DefaultLayout>

<script>
  import { getProducts, getCategories } from '@utils/clientApi'
  import type { Product, Category } from '@utils/clientApi'

  const loading = document.getElementById('loading')!
  const error = document.getElementById('error')!
  const content = document.getElementById('content')!
  const caseList = document.getElementById('case-list')!
  const caseCount = document.getElementById('case-count')!
  const tagsContainer = document.getElementById('tags-container')!
  const retryBtn = document.getElementById('retry-btn')!

  let allProducts: Product[] = []
  let allCategories: Category[] = []
  let selectedCategory: string | null = null

  const projectImages = [
    '/projects/project-image-1.png',
    '/projects/project-image-2.png',
    '/projects/project-image-3.png',
    '/projects/project-image-4.png',
    '/projects/project-image-5.png',
    '/projects/project-image-6.png',
  ]

  function slugify(text: string): string {
    return text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim()
  }

  function renderCaseCard(product: Product, index: number): string {
    const imageUrl = product.image_url || projectImages[index % projectImages.length]
    const detailUrl = `/portfolio/${slugify(product.id + '-' + product.name)}`

    return `
      <li>
        <article class="card h-full flex flex-col border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
          <a href="${detailUrl}" class="block">
            <img src="${imageUrl}" alt="" class="w-full h-48 object-cover" loading="lazy" />
          </a>
          <div class="p-6 flex-1 flex flex-col">
            <div class="mb-2">
              <span class="inline-block px-2 py-1 text-xs bg-primary text-white rounded">${product.category}</span>
            </div>
            <h2 class="text-xl font-bold mb-2">
              <a href="${detailUrl}" class="hover:text-primary">${product.name}</a>
            </h2>
            <p class="text-gray-600 mb-4 flex-1">${product.description}</p>
            <p class="text-sm text-gray-500">分类：${product.category}</p>
          </div>
        </article>
      </li>
    `
  }

  function renderTags() {
    const allTag = `
      <button class="tag-btn px-4 py-2 border rounded-lg hover:bg-gray-100 ${!selectedCategory ? 'bg-primary text-white border-primary' : ''}" 
              data-category="">
        全部案例
      </button>
    `

    const categoryTags = allCategories.map(cat => {
      const isActive = selectedCategory === cat.name
      return `
        <button class="tag-btn px-4 py-2 border rounded-lg hover:bg-gray-100 ${isActive ? 'bg-primary text-white border-primary' : ''}" 
                data-category="${cat.name}">
          ${cat.name}
        </button>
      `
    }).join('')

    tagsContainer.innerHTML = allTag + categoryTags

    // 添加事件监听
    document.querySelectorAll('.tag-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLButtonElement
        selectedCategory = target.dataset.category || null
        renderContent()
      })
    })
  }

  function renderContent() {
    const filteredProducts = selectedCategory
      ? allProducts.filter(p => p.category === selectedCategory)
      : allProducts

    caseCount.innerHTML = `<em>共 ${filteredProducts.length} 个案例${selectedCategory ? `（标签："${selectedCategory}"）` : ''}</em>`
    caseList.innerHTML = filteredProducts.map((product, index) => renderCaseCard(product, index)).join('')
    
    // 更新标签样式
    renderTags()
  }

  async function loadData() {
    loading.classList.remove('hidden')
    error.classList.add('hidden')
    content.classList.add('hidden')

    try {
      const [productsResponse, categoriesResponse] = await Promise.all([
        getProducts(),
        getCategories()
      ])

      allProducts = productsResponse.data
      allCategories = categoriesResponse.data

      renderTags()
      renderContent()

      loading.classList.add('hidden')
      content.classList.remove('hidden')
    } catch (err) {
      console.error('Failed to load cases:', err)
      loading.classList.add('hidden')
      error.classList.add('hidden')
    }
  }

  retryBtn.addEventListener('click', () => {
    loadData()
  })

  // 初始加载
  loadData()
</script>

<style>
  .card {
    background-color: var(--background-color);
    border-color: var(--border-color-subtle);
  }

  .card:hover {
    border-color: var(--primary-color);
  }

  .tag-btn.bg-primary {
    background-color: var(--primary-color);
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
